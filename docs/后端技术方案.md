# 后端技术方案

## 一、整体架构设计

### 1.1 双后端架构
- **本地后端**：基于Python FastAPI，处理免费功能和离线操作
- **云端后端**：基于Python FastAPI微服务，处理付费功能和AI增强服务
- **数据同步**：本地与云端通过增量同步保持数据一致性

### 1.2 技术栈选择
- **本地后端**：FastAPI + SQLite + 轻量级AI模型
- **云端后端**：FastAPI + PostgreSQL + Redis + 向量数据库
- **AI引擎**：LangChain/LlamaIndex + OpenAI/Gemini API
- **部署方案**：Docker + Kubernetes + 负载均衡

## 二、本地后端架构

### 2.1 服务模块设计
- **文件管理服务**：文件读写、目录操作、格式转换
- **编辑器服务**：Markdown解析、语法检查、预览生成
- **本地AI服务**：轻量级文本处理、基础标签生成、简单续写
- **搜索服务**：全文索引、关键词搜索、结果排序
- **数据管理服务**：SQLite操作、缓存管理、元数据维护

### 2.2 数据存储策略
- **文档存储**：直接存储在用户文件系统，支持任意格式
- **元数据存储**：SQLite数据库存储标签、链接、摘要等
- **缓存存储**：本地缓存AI结果、搜索索引、用户配置
- **临时存储**：编辑历史、撤销重做、临时文件

### 2.3 核心数据表设计
- **documents表**：文档基本信息、路径、哈希值、时间戳
- **tags表**：标签名称、颜色、层级关系、使用频率
- **links表**：双向链接关系、链接文本、创建时间
- **ai_cache表**：AI处理结果缓存、内容哈希、过期时间
- **search_index表**：全文搜索索引、关键词、位置信息

## 三、云端后端架构

### 3.1 微服务设计
- **认证服务**：用户注册登录、JWT管理、权限验证
- **同步服务**：文件同步、冲突解决、版本控制
- **AI服务**：大模型调用、DeepResearch、智能问答
- **搜索服务**：语义搜索、向量检索、知识图谱
- **计费服务**：使用量统计、订阅管理、支付处理

### 3.2 数据存储架构
- **关系数据库**：PostgreSQL存储用户数据、文档元数据
- **向量数据库**：ChromaDB/Pinecone存储文档向量化表示
- **缓存数据库**：Redis缓存会话、热点数据、临时结果
- **对象存储**：S3/OSS存储文件备份、AI生成内容

### 3.3 核心数据表设计
- **users表**：用户信息、订阅状态、使用配额
- **documents表**：云端文档元数据、同步状态、权限控制
- **sync_logs表**：同步记录、变更历史、冲突信息
- **ai_requests表**：AI调用记录、计费信息、结果缓存
- **knowledge_graph表**：实体关系、知识图谱、语义索引

## 四、AI服务架构

### 4.1 本地AI能力
- **文本处理**：基于spaCy的实体识别、关键词提取
- **基础续写**：轻量级语言模型、上下文分析
- **标签生成**：TF-IDF算法、预训练模型微调
- **摘要生成**：抽取式摘要、关键句识别

### 4.2 云端AI能力
- **DeepResearch**：多源信息聚合、文献分析、研究报告生成
- **智能问答**：跨文档推理、上下文理解、多轮对话
- **风格转换**：多风格生成、语气调节、专业度控制
- **配图生成**：AI绘图、风格选择、内容理解

### 4.3 AI工作流设计
- **任务分解**：复杂任务拆分为子任务
- **工具调用**：搜索引擎、PDF解析、数据库查询
- **结果聚合**：多源信息整合、去重、排序
- **质量评估**：结果验证、置信度计算、用户反馈

## 五、数据同步策略

### 5.1 增量同步机制
- **变更检测**：基于文件哈希和时间戳的变更识别
- **增量传输**：只传输变更部分，减少网络开销
- **批量处理**：批量上传下载，提高同步效率
- **断点续传**：支持大文件断点续传，提高可靠性

### 5.2 冲突解决策略
- **版本控制**：基于时间戳的版本管理
- **自动合并**：文本差异自动合并、元数据合并
- **用户选择**：冲突时提供用户选择界面
- **回滚机制**：支持版本回滚、操作撤销

### 5.3 同步状态管理
- **同步队列**：待同步操作队列管理
- **状态监控**：同步进度、错误状态、网络状态
- **重试机制**：失败重试、指数退避、最大重试次数
- **离线处理**：离线时本地缓存，联网后批量同步

## 六、安全与权限设计

### 6.1 用户认证
- **JWT令牌**：无状态认证、自动刷新、安全传输
- **OAuth集成**：支持第三方登录、权限委托
- **多因素认证**：短信验证、邮箱验证、安全密钥

### 6.2 数据安全
- **端到端加密**：敏感数据加密传输和存储
- **访问控制**：基于角色的权限控制、资源隔离
- **审计日志**：操作记录、访问日志、安全事件

### 6.3 API安全
- **速率限制**：防止API滥用、DDoS防护
- **输入验证**：参数校验、SQL注入防护、XSS防护
- **HTTPS强制**：所有API调用强制使用HTTPS

## 七、性能优化策略

### 7.1 数据库优化
- **索引优化**：合理设计索引、查询优化
- **连接池**：数据库连接复用、连接数控制
- **读写分离**：主从复制、读写分离部署
- **分库分表**：大数据量水平分片、垂直分片

### 7.2 缓存策略
- **多级缓存**：内存缓存、Redis缓存、CDN缓存
- **缓存预热**：热点数据预加载、定期更新
- **缓存失效**：智能失效策略、一致性保证
- **缓存穿透**：布隆过滤器、空值缓存

### 7.3 负载均衡
- **服务发现**：动态服务注册、健康检查
- **负载分发**：轮询、权重、最少连接数
- **故障转移**：自动故障检测、服务切换
- **弹性伸缩**：自动扩缩容、资源动态调整
