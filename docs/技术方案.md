# 技术方案

一、 架构总览

该方案采用三层架构：
1. 前端 (Electron)：提供用户界面，处理用户交互，并根据功能类型将请求分发给本地或云端后端。
2. 本地后端 (Python)：作为独立进程在用户设备上运行，负责所有免费、离线和性能敏感的功能。
3. 云端后端 (Python)：部署在云服务器上，处理所有付费、需要强大算力和大规模数据的功能。

---
二、 技术选型
- 前端：
  - 主框架：Electron，用于构建跨平台的桌面应用。
  - UI 框架：React/Vue/Svelte，选择其中一个现代前端框架来高效构建用户界面。
  - 本地通信：IPC (Inter-Process Communication)，用于 Electron 前端主进程与本地 Python 后端的通信。
- 本地后端：
  - 核心框架：FastAPI 或 Flask，轻量级且高效的 Python Web 框架，用于构建本地 API 服务。
  - 数据存储：SQLite，轻量级的嵌入式数据库，用于存储标签、链接、实体关系、缓存等元数据。
  - 模型：使用 ONNX 或 TensorRT 等技术优化的轻量级 AI 模型，用于本地文本处理和分析。
  - 依赖打包：PyInstaller，用于将 Python 脚本及其所有依赖打包成一个可执行文件，方便与 Electron 应用一起分发。
- 云端后端：
  - 核心框架：FastAPI，因为它具备高性能、异步支持和强大的类型校验，非常适合处理高并发的 API 请求。
  - 用户认证：OAuth 2.0/JWT，用于安全地处理用户登录和 API 权限验证。
  - AI 引擎：LangChain/LlamaIndex，用于编排 AI Agent 的工作流，集成不同的工具（如搜索引擎、PDF 解析）。
  - 云端模型：OpenAI API/Google Gemini API，或自建的开源 LLM（如 Llama3）服务，提供强大的自然语言处理能力。
  - 云数据存储：PostgreSQL/MongoDB，用于存储云同步文件元数据、用户数据和大规模的知识图谱数据。
  - 向量数据库：ChromaDB/Pinecone/Weaviate，用于存储和检索文档的向量化表示，支持语义搜索和问答。

---
三、 核心功能与实现方案
1. 启动与通信
- 应用启动：Electron 主进程在启动时，会执行一个脚本来启动本地 Python 后端服务，并监听一个本地端口（如 http://127.0.0.1:8000）。
- 前端与本地后端通信：
  - 免费功能：前端通过 IPC 调用，直接向本地 Python 后端发送 HTTP 请求。
  - 付费功能：前端在验证用户身份和权限后，通过 HTTPS 向云端后端发送请求。
- 网络状态管理：Electron 应用将持续监听网络连接状态。在断网时，前端只显示和启用本地功能，付费功能将被置灰并提示用户联网。
2. 数据存储与同步
- 本地存储：
  - 所有 Markdown 文件以 .md 纯文本格式直接存储在用户的文件系统中。
  - 使用 SQLite 数据库存储文档元数据，如标题、标签、双向链接关系、缓存、待办事项、以及 AI 生成的大纲和摘要。
- 云同步（付费）：
  - 当用户开通云同步服务并登录后，前端会启动一个后台任务。
  - 这个任务监控本地文件系统和 SQLite 数据库的变更，并将增量快照通过 HTTPS 协议发送到云端后端。
  - 云端后端负责处理多设备间的版本冲突和数据合并。
3. AI Agent 功能实现
- 本地 AI Agent（免费）：
  - 本地 Python 后端使用轻量级模型实现：
    - 智能标签：基于 TF-IDF 或预训练的 BERT 模型，对文本进行关键词提取。
    - 实体识别：使用 spaCy 等 NLP 库，识别人物、地点、组织等实体。
    - 简单续写：使用经过蒸馏或量化的微型 LLM。
- 云端 AI Agent（付费）：
  - 云端 Python 后端使用 LangChain/LlamaIndex 框架来编排复杂的 Agent 任务。
  - AI DeepResearch：
    1. 接收用户查询。
    2. Agent 规划：将查询分解为子任务。
    3. 工具调用：调用搜索引擎 API 抓取网页内容，调用 PDF 解析器处理学术文档。
    4. 数据聚合：将所有抓取的信息进行清洗、去重和摘要。
    5. 推理生成：结合用户知识库和外部信息，生成一份综合性研究报告。
  - 跨文档智能问答：
    1. 将用户知识库内容（本地同步到云端的部分）和云端知识图谱向量化后存储在向量数据库中。
    2. 用户提问时，Agent 将问题向量化，并在向量数据库中进行语义检索。
    3. 将检索到的相关文档片段作为上下文，送入 LLM 进行推理，生成精准答案。
4. 用户认证与计费
- 用户登录：Electron 前端提供登录界面，用户输入凭证，前端向云端后端请求认证。成功后，云端后端发放 JWT Token。
- 权限校验：前端在调用云端 API 时，在请求头中附带 JWT Token。云端后端在每个需要权限的 API 接口前，校验 Token 的有效性和用户的订阅状态。
- 调用量计费：云端后端对 AI DeepResearch 等高成本 API 的调用进行记录，并与用户的账户进行关联，实现按量计费。

---
四、 通信策略设计

### 4.1 本地通信协议
- **IPC通信模式**：
  - 前端通过IPC向本地后端发送文件操作、编辑器功能、本地AI处理等请求
  - 本地后端通过HTTP API响应请求，返回处理结果
  - 支持同步和异步两种通信模式，根据功能复杂度选择

- **WebSocket实时通信**：
  - 用于实时协作功能，如多用户同时编辑同一文档
  - 支持实时状态同步，如文件变更通知、AI处理进度
  - 实现心跳检测，确保连接稳定性

### 4.2 云端通信协议
- **RESTful API设计**：
  - 认证相关：登录、注册、令牌刷新、权限验证
  - 文件同步：上传、下载、冲突解决、版本控制
  - AI服务：智能续写、摘要生成、DeepResearch、配图生成
  - 搜索服务：语义搜索、智能问答、知识图谱查询
  - 用户管理：订阅管理、使用量统计、偏好设置

- **GraphQL查询优化**：
  - 复杂数据查询，如文档及其关联的标签、链接、AI建议
  - 减少网络请求次数，提高数据获取效率
  - 支持实时订阅，如文档变更通知

### 4.3 数据同步策略
- **增量同步机制**：
  - 基于文件哈希和时间戳的变更检测
  - 只传输变更部分，减少网络开销
  - 支持批量操作，提高同步效率
  - 实现断点续传，处理大文件同步

- **冲突解决策略**：
  - 基于时间戳的版本控制
  - 自动合并文本差异和元数据
  - 提供用户选择界面处理复杂冲突
  - 支持版本回滚和操作撤销

- **同步状态管理**：
  - 维护同步队列，管理待同步操作
  - 实时监控同步进度和网络状态
  - 实现失败重试机制，使用指数退避策略
  - 离线时本地缓存，联网后批量同步

### 4.4 网络状态管理
- **在线状态检测**：
  - 持续监控网络连接状态
  - 自动切换在线/离线模式
  - 提供网络状态指示器

- **离线优先策略**：
  - 离线时禁用云端功能，启用本地功能
  - 本地缓存关键数据，保证基本功能可用
  - 联网后自动同步离线期间的操作

- **连接质量优化**：
  - 根据网络质量调整同步策略
  - 低带宽时优先同步重要数据
  - 支持网络切换时的无缝过渡

### 4.5 安全通信保障
- **传输加密**：
  - 所有云端通信使用HTTPS/TLS加密
  - 本地通信使用IPC安全通道
  - 敏感数据端到端加密

- **身份验证**：
  - JWT令牌管理，支持自动刷新
  - 多因素认证，提高账户安全性
  - 基于角色的权限控制

- **数据完整性**：
  - 数据校验和，确保传输完整性
  - 防重放攻击，使用时间戳和随机数
  - 审计日志，记录所有关键操作
