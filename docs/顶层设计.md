### 顶层目标与边界
- **目标**: Workspace 作为「场景容器 + 沉浸空间 + AI 协作中台」，Editor 作为「多形态内容引擎」，两者严格解耦。
- **边界**:
  - Workspace 负责路由、场景切换、权限/导出、任务编排与多文档组织。
  - Editor 负责 AST 渲染/交互、模式适配（富文本/图谱/Canvas/表格/时间线）、性能与错误。
- 注意：本方案仅给出数据流与关键字段，不落具体接口/表/代码细节，以保持技术方案文档的抽象层级[[memory:4898117]]。

### 分层架构（Logical Layers）
- **App Shell/Routes**: `Next.js` 路由与布局；`/workspace/[id]?mode=&template=`
- **Workspace 容器**: 页面级状态（项目元信息、权限、共享面板、导出面板）
- **EditorKit（集成层）**:
  - 统一初始化/销毁、模式切换、AI/性能/错误开关、与 Workspace 的 API（导入/导出/撤销/重做）
  - 抽象依赖：`AdapterFactory`、`StateManager`、`PluginSystem`、`AI Engine Bridge`
- **AdapterFactory（优化版）**:
  - 注册/延迟加载/健康检查/依赖校验；按 `EditorType + SceneTemplate` 创建增强适配器（Error/Perf/AI mixin）
- **Adapters（富文本/图谱/Canvas/表格/时间线）**:
  - 单一职责：渲染+交互+事件；不做跨模块逻辑
- **EditorStateManager**:
  - 快照与撤销/重做；导入导出；本地持久化；（可选）协作占位
- **PluginSystem**:
  - 动态加载/卸载，权限、依赖、生命周期；事件与消息；持久化；AST Provider
- **AI Engine Bridge**:
  - 统一 AI 调用（补全/重写/研究/知识抽取/建议），配置/熔断/重试；上下文抽象
- **Persistence/Sync**:
  - 本地持久化（localStorage/IndexedDB）；云端同步与历史（后续集成）
- **Telemetry & Error**:
  - 统一错误分类/恢复策略；操作/渲染/内存指标；健康评分与建议

### 关键数据与事件（协议对齐）
- **核心数据对象（关键字段）**
  - `DocumentAST`: { id, version, title, root, metadata.updatedAt, settings.theme }
  - `Selection`: { type('node'|'text'|'mixed'), nodeIds[], range?{ start,end,nodeId } }
  - `Viewport`: { x,y,width,height,zoom }
  - `SceneTemplate`: writing/research/planning/learning/creative
  - `EditorType`: rich-text/graph/canvas/table/timeline
- **统一事件协议（所有适配器）**
  - `viewChange`:
    - `type: 'contentUpdate'`，至少包含：{ astVersion, updatedAt }；建议附 `content` 或 `astDelta`（大小受控）
    - `type: 'viewport'`：{ viewport }
  - `selectionChange`: { selection }
  - `focus` / `blur`
  - `nodeClick` / `nodeDoubleClick`: { nodeId, eventMeta? }
  - `error`: { message, cause?, recoverable? }
  - 说明：富文本额外可提供 `getAST()` 用于拉取结构化 AST；其他适配器等价提供
- **EditorKit 与 StateManager 数据流**
  - 适配器发出 `contentUpdate` → EditorKit 优先 `adapter.getAST()` 拉取最新 AST → 记入 StateManager 快照（operation: contentUpdate）→ 通知 PluginSystem
  - `selectionChange` → 轻量快照（可抽样）
  - `undo/redo` → 由 EditorKit 触发，StateManager 返回快照 → EditorKit 调用 `adapter.render(snapshot.ast)`
- **AI 调用流**
  - EditorKit 暴露 `requestAICompletion/Rewrite/...` → 透传至适配器的 AI mixin（或 Bridge）→ 返回结果 → 适配器应用内容（如插入补全）→ 发出 `contentUpdate`
- **插件数据流**
  - PluginSystem 初始化时注入 `AST Provider`（EditorKit 提供）与 `adapter`；插件可 `getAST()`、`updateContent(ast)`、`updateSelection(selection)`；插件间用消息与事件总线通讯

### 模式切换与生命周期
- 路由切换或 UI 切换模式：
  - EditorShell → 计算 `EditorType/SceneTemplate` → EditorKit 销毁旧适配器/创建新适配器 → 渲染当前 AST → 绑定事件 → 性能监控开始
- 销毁：
  - 先停止监控/清理监听/销毁适配器 → PluginSystem 卸载插件 → StateManager 持久化并释放资源

### 横切关注点（统一标准）
- **错误处理**
  - 分类：initialization/rendering/memory/user_interaction/network/validation/unknown
  - 策略：自动恢复（重建适配器）；手动恢复（UI 提示）；降级（禁用特性）
- **性能监控**
  - 指标：平均渲染/操作时长、内存、慢操作列表、错误率、健康评分
  - 建议项：虚拟滚动、事件去抖节流、监听清理、结构压缩
- **安全/权限**
  - 插件权限：read/write/admin（禁止第三方 system 权限）
  - 资源加载：HTTPS 与白名单模块；沙箱执行
- **可扩展性**
  - 通过 AdapterFactory 注册/懒加载新适配器
  - PluginSystem 基于元数据+依赖图管理；面板/对话框/UI 通道对齐 Workspace

### 运行时契约（高层约束）
- 适配器必须实现：
  - `create/destroy/render/setSelection/getSelection/getViewport/setViewport/focus/blur`
  - 发射：`viewChange(contentUpdate|viewport)`、`selectionChange`、`error`
  - 能力声明：{ canEdit, canSelect, canZoom, canDrag, supportsUndo, supportsSearch, supportsAI }
- EditorKit 必须保障：
  - 事件去抖、防抖；异常不外溢；状态一致性（渲染前后 AST 与 Selection 对齐）
  - 对可选能力的存在性检测（AI/Perf）

### 路由与场景
- `'/workspace/[id]?mode=&template='`：
  - `mode` 决定 `EditorType`；`template` 决定 `SceneTemplate`
  - 未显式 template 时由 `detectScene(AST)` 推断并提示切换（带可取消）

### 导出/历史/回放
- 导出：JSON/HTML/Markdown（通过 ASTUtils 转换）；HTML/MD 逐步覆盖更多节点类型
- 历史：StateManager 导入/导出；`/workspace/[id]/history` 页面对接回放与语义回滚

### 里程碑与落地顺序
- Phase A（对齐与底座收口）
  - 统一事件协议（已完成初版）
  - EditorKit 接入 StateManager/PluginSystem/AI Bridge（已接入）
  - 富文本适配器补 `getAST()` 与 `contentUpdate` 携带关键信息
- Phase B（适配器对齐）
  - Graph/Canvas/Table/Timeline 补齐最小实现与事件发射；统一能力声明
- Phase C（Workspace 联动）
  - 历史页面接入 StateManager；导出 HTML/Markdown 落地；场景检测与推荐切换
- Phase D（插件生态）
  - 插件生命周期面板、配置面板；AI 插件样例（翻译/润色/检索）

### 验收标准（关键）
- 模式切换无刷新、状态不丢失，错误可自动恢复/手动重试
- 事件协议一致，`contentUpdate` 能驱动快照/撤销/插件刷新
- 性能监控可见，健康评分可用；插件系统支持加载/卸载/通信
- 